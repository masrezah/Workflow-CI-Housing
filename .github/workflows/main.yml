name: Training Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-train:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        pip install pandas scikit-learn mlflow==2.19.0 numpy

    - name: Find and Run MLflow Project
      run: |
        # 1. Cari di mana file MLproject berada
        echo "Sedang mencari file MLproject..."
        PROJECT_FILE=$(find . -name MLproject -type f | head -n 1)
        
        if [ -z "$PROJECT_FILE" ]; then
          echo "ERROR: File MLproject tidak ditemukan di repository ini!"
          echo "Daftar semua file:"
          ls -R
          exit 1
        fi
        
        # 2. Ambil nama foldernya
        PROJECT_DIR=$(dirname "$PROJECT_FILE")
        echo "File ditemukan di: $PROJECT_FILE"
        echo "Menjalankan MLflow project di folder: $PROJECT_DIR"
        
        # 3. Jalankan MLflow di folder yang ditemukan tadi
        mlflow run "$PROJECT_DIR" --env-manager=local

    - name: Commit and Push Metrics (Syarat Skilled)
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Cari file metrics.txt di mana saja
        METRICS_FILE=$(find . -name metrics.txt -type f | head -n 1)
        
        if [ -n "$METRICS_FILE" ]; then
           echo "Metrics ditemukan di: $METRICS_FILE"
           git add "$METRICS_FILE"
           git commit -m "Auto-update: Model metrics updated by GitHub Actions" || echo "Tidak ada perubahan untuk di-commit"
           git push
        else
           echo "Peringatan: metrics.txt tidak ditemukan. Pastikan script modelling.py membuatnya."
        fi
